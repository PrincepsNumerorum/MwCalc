<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>数学基礎講座：不等式と関数の構造（完全統合版）</title>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    window.MathJax = {
        tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] },
        svg: { fontCache: 'global' }
    };
</script>

<style>
    :root {
        --bg-color: #121212;
        --text-color: #e0e0e0;
        --accent-primary: #00d2ff; /* Cyber Blue */
        --accent-secondary: #ff007a; /* Neon Pink */
        --accent-tertiary: #00ff9d; /* Neon Green */
        --accent-warn: #ffcc00; /* Warning Yellow */
        --panel-bg: #1e1e1e;
        --slide-padding: 40px;
    }

    body {
        margin: 0;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", sans-serif;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
    }

    /* Presentation Container */
    #deck {
        position: relative;
        width: 100%;
        height: 100%;
        perspective: 1000px;
    }

    .slide {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        padding: var(--slide-padding);
        
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        
        opacity: 0;
        pointer-events: none;
        transform: translate3d(50px, 0, 0);
        transition: opacity 0.4s ease, transform 0.4s ease;
        z-index: 0;
        overflow-y: auto; 
    }

    .slide::-webkit-scrollbar { width: 8px; }
    .slide::-webkit-scrollbar-track { background: transparent; }
    .slide::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

    .slide.active {
        opacity: 1;
        pointer-events: auto;
        transform: translate3d(0, 0, 0);
        z-index: 10;
    }

    .slide.past {
        opacity: 0;
        transform: translate3d(-50px, 0, 0);
    }

    /* Typography */
    h1 { font-size: 2.8rem; margin: 0 0 20px 0; color: var(--accent-primary); text-align: center; line-height: 1.2; text-shadow: 0 0 15px rgba(0, 210, 255, 0.3); }
    h2 { font-size: 2rem; margin-bottom: 20px; border-bottom: 2px solid var(--accent-primary); color: #fff; display: inline-block; padding-bottom: 5px; text-align: center;}
    h3 { font-size: 1.5rem; color: var(--accent-tertiary); margin: 10px 0; }
    p, li { font-size: 1.4rem; line-height: 1.5; margin-bottom: 0.6rem; max-width: 95%; }
    
    ul { list-style: none; padding: 0; margin: 0; }
    li { position: relative; padding-left: 1.2em; margin-bottom: 0.5em; }
    li::before { content: "➤"; position: absolute; left: 0; color: var(--accent-primary); font-size: 0.8em; top: 0.2em; }

    .highlight { color: var(--accent-secondary); font-weight: bold; }
    .important { color: var(--accent-tertiary); font-weight: bold; border-bottom: 2px solid var(--accent-tertiary); }
    .warn { color: var(--accent-warn); font-weight: bold; }

    /* Box Styles */
    .box {
        background: var(--panel-bg);
        border: 1px solid #444;
        border-radius: 12px;
        padding: 15px 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        margin: 10px 0;
        text-align: center;
        width: fit-content;
        min-width: 300px;
        max-width: 90%;
    }

    /* Fragment Animation */
    .fragment {
        opacity: 0;
        transform: translateY(10px);
        transition: all 0.3s ease-out;
    }
    .fragment.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* Interactive Elements & SVG */
    .interactive-area {
        background: #000;
        border: 1px solid #333;
        border-radius: 15px;
        padding: 15px;
        margin-top: 10px;
        text-align: center;
        box-shadow: inset 0 0 40px rgba(0,0,0,0.8);
        width: 100%;
        max-width: 800px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    svg { 
        overflow: visible; 
        width: 100%; 
        height: auto;
        max-height: 40vh;
        display: block;
        margin: 0 auto;
    }

    input[type=range] { width: 100%; margin: 0; cursor: pointer; accent-color: var(--accent-primary); }

    /* Controls */
    #controls {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
    }
    .btn {
        background: rgba(255,255,255,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        padding: 10px 20px;
        cursor: pointer;
        border-radius: 5px;
        font-size: 1rem;
        transition: all 0.2s;
        backdrop-filter: blur(5px);
    }
    .btn:hover { background: var(--accent-primary); color: #000; border-color: var(--accent-primary); }

    #progress-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        height: 5px;
        background: var(--accent-primary);
        width: 0%;
        transition: width 0.3s;
        z-index: 100;
    }

    #slide-number {
        position: fixed;
        bottom: 20px;
        left: 20px;
        color: #555;
        font-size: 1.2rem;
        font-family: monospace;
    }

    .row { display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; width: 100%; }
    .col { flex: 1; min-width: 250px; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 1.4rem; }
    th, td { border: 1px solid #444; padding: 10px; text-align: center; vertical-align: middle;}
    th { background: #333; color: var(--accent-primary); }
    td { background: rgba(255,255,255,0.05); }

    /* Slider Groups */
    .slider-container {
        width: 95%;
        max-width: 600px;
        margin: 10px auto;
        background: rgba(255,255,255,0.05);
        padding: 10px;
        border-radius: 10px;
    }
    .slider-row {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 5px;
    }
    .slider-label {
        width: 60px;
        font-weight: bold;
        text-align: right;
        font-family: monospace;
        font-size: 1.1rem;
    }

    /* Animation Classes */
    .anim-box { stroke: var(--accent-primary); stroke-width: 2; fill: rgba(0, 210, 255, 0.2); transition: all 0.5s; }
    .anim-rect { stroke: var(--accent-secondary); stroke-width: 2; fill: rgba(255, 0, 122, 0.2); transition: all 0.5s; }
    .anim-target { stroke: var(--accent-tertiary); stroke-width: 2; fill: none; stroke-dasharray: 5; }
    .anim-fill { fill: var(--accent-tertiary); opacity: 0; transition: opacity 0.5s; }
    
    /* Quiz Styles */
    .quiz-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 900px; }
    .quiz-item { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #444; cursor: pointer; transition: 0.3s; }
    .quiz-item:hover { background: #333; border-color: var(--accent-primary); }
    .quiz-q { font-weight: bold; margin-bottom: 10px; font-size: 1.2rem; }
    .quiz-a { display: none; color: var(--accent-tertiary); margin-top: 10px; border-top: 1px solid #555; padding-top: 5px; font-size: 1.2rem;}
    .quiz-item.revealed .quiz-a { display: block; }

</style>
</head>
<body>

<div id="deck">

    <div class="slide active">
        <h1>数学基礎講座</h1>
        <p style="letter-spacing: 0.2em; color: #888;">HIGH SCHOOL MATH RESTART</p>
        <div class="box" style="margin-top: 30px;">
            <p style="margin:0.5em 0;">テーマ：世界を「範囲」で捉える技術</p>
            <p style="margin:0.5em 0; font-size: 2.2rem; color: var(--accent-primary);">不等式と関数の構造</p>
        </div>
        <p style="font-size: 1rem; margin-top: 40px; opacity: 0.6;">[→] キーまたは右下のボタンで進む</p>
    </div>

    <div class="slide">
        <h2>第1章：等式(=)から不等式へ</h2>
        <p>これまで、皆さんは「等式」の世界にいました。</p>
        <div class="box fragment">
            <p style="font-size: 2.5rem;">$2x = 1000$</p>
            <p>$\downarrow$</p>
            <p style="font-size: 2.5rem;">$x = 500$</p>
        </div>
        <p class="fragment">この式は、<strong>正解がたった1つの値に定まる</strong>ことを意味します。</p>
    </div>

    <div class="slide">
        <h2>現実は「範囲」で動いている</h2>
        <p>現実世界では、値が1点に定まることの方が稀です。</p>
        <div class="row">
            <div class="col fragment box">
                <h3>買い物</h3>
                <p>所持金1000円。<br>990円でも100円でも買える。<br>$\to$ <strong>1000円以下</strong></p>
            </div>
            <div class="col fragment box">
                <h3>エレベーター</h3>
                <p>定員9人。<br>1人でも5人でも動く。<br>$\to$ <strong>9人以下</strong></p>
            </div>
            <div class="col fragment box">
                <h3>制限速度</h3>
                <p>制限60km/h。<br>61km/h以上は違反。<br>$\to$ <strong>60km/h超</strong></p>
            </div>
        </div>
        <p class="fragment" style="margin-top:20px;">この「幅（レンジ）」を扱うことができるのが<strong>不等式</strong>です。</p>
    </div>

    <div class="slide">
        <h2>不等式のイメージ</h2>
        <p>「点」ではなく「領域（エリア）」を指定します。</p>
        <div class="interactive-area" style="height: 200px;">
            <svg viewBox="0 0 500 100">
                <line x1="20" y1="50" x2="480" y2="50" stroke="#555" stroke-width="2"/>
                <g class="fragment">
                    <circle cx="250" cy="50" r="5" fill="var(--accent-primary)"/>
                    <text x="250" y="80" fill="var(--accent-primary)" text-anchor="middle">x = 0 (点)</text>
                </g>
                <g class="fragment">
                    <rect x="250" y="40" width="230" height="20" fill="var(--accent-secondary)" opacity="0.3"/>
                    <line x1="250" y1="50" x2="480" y2="50" stroke="var(--accent-secondary)" stroke-width="4"/>
                    <text x="365" y="30" fill="var(--accent-secondary)" text-anchor="middle">x > 0 (範囲)</text>
                </g>
            </svg>
        </div>
    </div>

    <div class="slide">
        <h2>4つの不等号</h2>
        <table>
            <tr><th>記号</th><th>意味</th><th>境界線</th></tr>
            <tr class="fragment"><td>$x > 3$</td><td>3より大きい</td><td>含まない (白丸)</td></tr>
            <tr class="fragment"><td>$x \ge 3$</td><td>3以上</td><td>含む (黒丸)</td></tr>
            <tr class="fragment"><td>$x < 3$</td><td>3より小さい</td><td>含まない (白丸)</td></tr>
            <tr class="fragment"><td>$x \le 3$</td><td>3以下</td><td>含む (黒丸)</td></tr>
        </table>
    </div>

    <div class="slide">
        <h2>「含む」か「含まない」か</h2>
        <p>数直線の書き方には、世界共通のルールがあります。</p>
        <div class="interactive-area">
            <svg viewBox="0 0 500 150">
                <line x1="50" y1="75" x2="450" y2="75" stroke="#555" stroke-width="2"/>
                <circle cx="150" cy="75" r="10" stroke="var(--accent-primary)" stroke-width="3" fill="#000"/>
                <text x="150" y="120" fill="white" text-anchor="middle">○ (含まない)</text>
                <text x="150" y="40" fill="var(--accent-primary)" text-anchor="middle">$x > 3$</text>
                <path d="M 160 75 L 400 75" stroke="var(--accent-primary)" stroke-width="5" marker-end="url(#arrow-blue)"/>
                
                <circle cx="350" cy="75" r="10" fill="var(--accent-secondary)"/>
                <text x="350" y="120" fill="white" text-anchor="middle">● (含む)</text>
                <text x="350" y="40" fill="var(--accent-secondary)" text-anchor="middle">$x \le 3$</text>
                <path d="M 350 75 L 100 75" stroke="var(--accent-secondary)" stroke-width="5" opacity="0.5" marker-end="url(#arrow-pink)"/>

                <defs>
                    <marker id="arrow-blue" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="var(--accent-primary)" /></marker>
                    <marker id="arrow-pink" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="var(--accent-secondary)" /></marker>
                </defs>
            </svg>
        </div>
        <p class="fragment">白丸＝境界を含まない<br>黒丸＝境界を含む</p>
    </div>

    <div class="slide">
        <h2>不等号の性質</h2>
        <div class="row">
            <div class="col fragment box">
                <h3>足し算・引き算</h3>
                <p>$5 > 2$<br>$\downarrow (+3)$<br>$8 > 5$</p>
                <p>大小関係は<strong>変わらない</strong></p>
            </div>
            <div class="col fragment box">
                <h3>正の数で掛け算</h3>
                <p>$5 > 2$<br>$\downarrow (\times 3)$<br>$15 > 6$</p>
                <p>大小関係は<strong>変わらない</strong></p>
            </div>
        </div>
    </div>

    <div class="slide">
        <h2 style="color: var(--accent-warn);">最大の注意点：負の数での操作</h2>
        <div class="box fragment" style="border-color: var(--accent-warn);">
            <p style="font-size: 1.5rem;">マイナスの数を<br>「掛ける」「割る」ときだけ<br><span class="warn" style="font-size:2rem;">不等号の向きが逆転する</span></p>
        </div>
        <p class="fragment">なぜでしょうか？ 納得するまで進みません。</p>
    </div>

    <div class="slide">
        <h2>実験：負の数を掛けてみる</h2>
        <p>$5 > 2$ （5は2より大きい）</p>
        <p class="fragment">両辺に $-1$ を掛けてみましょう。</p>
        <div class="box fragment">
            <p>$-5$ (5万の借金) vs $-2$ (2万の借金)</p>
        </div>
        <p class="fragment">借金5万の方が、借金2万よりも<br><strong>経済的な負担は大きい（値としては小さい）</strong>ですね。</p>
        <div class="box fragment">
            <p style="font-size: 2.5rem; color: var(--accent-warn);">$-5 < -2$</p>
        </div>
    </div>

    <div class="slide">
        <h2>視覚化：数直線の反転</h2>
        <p>「マイナスを掛ける」とは、数直線の左右を反転させる操作です。</p>
        <div class="interactive-area">
            <svg id="svg-flip" viewBox="-250 -60 500 120" style="background: #222;">
                <line x1="-240" y1="0" x2="240" y2="0" stroke="#555" stroke-width="2"/>
                <line x1="0" y1="-30" x2="0" y2="30" stroke="#fff" stroke-width="2"/>
                <text x="0" y="50" fill="white" text-anchor="middle">0 (中心)</text>
                <g id="flip-group">
                    <g id="ball-2"><circle cx="80" cy="0" r="10" fill="var(--accent-primary)"/><text x="80" y="-20" fill="var(--accent-primary)" text-anchor="middle" font-size="20">2</text></g>
                    <g id="ball-5"><circle cx="200" cy="0" r="15" fill="var(--accent-secondary)"/><text x="200" y="-20" fill="var(--accent-secondary)" text-anchor="middle" font-size="20">5</text></g>
                    <text id="text-ineq" x="140" y="30" fill="#888" text-anchor="middle">5 > 2</text>
                </g>
            </svg>
            <input type="range" id="flip-slider" min="0" max="180" value="0" step="1" oninput="updateFlip()">
            <p>スライダーを動かしてください。<br>右にあった「大きい数」ほど、左の奥へ移動します。</p>
        </div>
    </div>

    <div class="slide">
        <h2>第2章：一次不等式の解法</h2>
        <p>例題1： $3x - 5 > 4$</p>
        <div class="box fragment" style="text-align: left;">
            <p>① 移項する（方程式と同じ）</p>
            <p style="padding-left: 20px;">$3x > 4 + 5$</p>
            <p style="padding-left: 20px;">$3x > 9$</p>
            <p>② $x$の係数(3)で割る</p>
            <p style="padding-left: 20px;">$3$はプラスなので、向きそのまま。</p>
            <p style="padding-left: 20px; font-size: 2rem;" class="highlight">$x > 3$</p>
        </div>
    </div>

    <div class="slide">
        <h2>例題2：負の数で割る</h2>
        <p>例題2： $-2x + 6 \le 14$</p>
        <div class="box fragment" style="text-align: left;">
            <p>① 移項する</p>
            <p style="padding-left: 20px;">$-2x \le 14 - 6$</p>
            <p style="padding-left: 20px;">$-2x \le 8$</p>
            <p>② $x$の係数(-2)で割る <span class="warn">（注意！）</span></p>
            <p style="padding-left: 20px;">マイナスで割るため、向きを反転させます。</p>
            <p style="padding-left: 20px; font-size: 2rem;" class="highlight">$x \ge -4$</p>
        </div>
    </div>

    <div class="slide">
        <h2>【演習】一次不等式ドリル</h2>
        <div class="quiz-container">
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q1. $x - 4 > 2$</div><div class="quiz-a">$x > 6$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q2. $2x \le -10$</div><div class="quiz-a">$x \le -5$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q3. $-3x < 9$</div><div class="quiz-a">$x > -3$ <span class="warn">(逆転！)</span></div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q4. $-x + 1 \ge 5$</div><div class="quiz-a">$-x \ge 4 \to x \le -4$</div></div>
        </div>
    </div>

    <div class="slide">
        <h2>第3章：連立不等式</h2>
        <p>「条件A」<strong>かつ</strong>「条件B」</p>
        <div class="box fragment">
            <p>例：予算は1000円以内 ($x \le 1000$)</p>
            <p>かつ</p>
            <p>500円以上は使いたい ($x \ge 500$)</p>
        </div>
        <p class="fragment">この「共通範囲（重なり）」を探す作業です。</p>
    </div>

    <div class="slide">
        <h2>解き方：数直線を描く</h2>
        <p>$\begin{cases} x > 2 \\ x \le 5 \end{cases}$</p>
        <div class="interactive-area">
            <svg viewBox="0 0 500 150">
                <line x1="50" y1="100" x2="450" y2="100" stroke="#fff" stroke-width="2"/>
                <line x1="150" y1="100" x2="150" y2="50" stroke="var(--accent-primary)" stroke-width="2"/>
                <circle cx="150" cy="100" r="6" fill="#000" stroke="var(--accent-primary)" stroke-width="2"/>
                <line x1="150" y1="50" x2="450" y2="50" stroke="var(--accent-primary)" stroke-width="2"/>
                <text x="150" y="130" fill="white" text-anchor="middle">2</text>
                <line x1="350" y1="100" x2="350" y2="70" stroke="var(--accent-secondary)" stroke-width="2"/>
                <circle cx="350" cy="100" r="6" fill="var(--accent-secondary)"/>
                <line x1="350" y1="70" x2="50" y2="70" stroke="var(--accent-secondary)" stroke-width="2"/>
                <text x="350" y="130" fill="white" text-anchor="middle">5</text>
                <rect x="150" y="50" width="200" height="50" fill="var(--accent-tertiary)" opacity="0.2"/>
                <text x="250" y="40" fill="var(--accent-tertiary)" text-anchor="middle">共通範囲 (2 < x ≦ 5)</text>
            </svg>
        </div>
        <p>数直線を描いて、「線が2本重なっているところ」が答えです。</p>
    </div>

    <div class="slide">
        <h2>解なしパターン</h2>
        <p>$\begin{cases} x < 2 \\ x > 5 \end{cases}$</p>
        <div class="interactive-area" style="height:150px;">
            <svg viewBox="0 0 500 100">
                <line x1="50" y1="80" x2="450" y2="80" stroke="#fff" stroke-width="2"/>
                <path d="M 150 80 L 150 40 L 50 40" stroke="var(--accent-primary)" stroke-width="2" fill="none"/>
                <circle cx="150" cy="80" r="6" stroke="var(--accent-primary)" fill="#000"/>
                <text x="150" y="110" fill="white" text-anchor="middle">2</text>
                <path d="M 350 80 L 350 40 L 450 40" stroke="var(--accent-secondary)" stroke-width="2" fill="none"/>
                <circle cx="350" cy="80" r="6" stroke="var(--accent-secondary)" fill="#000"/>
                <text x="350" y="110" fill="white" text-anchor="middle">5</text>
            </svg>
        </div>
        <p class="fragment">重なりがありません。<br>この場合、答えは<strong>「解なし」</strong>となります。</p>
    </div>

    <div class="slide">
        <h2>【演習】連立不等式</h2>
        <div class="quiz-container">
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q1. $\begin{cases} x > 1 \\ x < 4 \end{cases}$</div><div class="quiz-a">$1 < x < 4$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q2. $\begin{cases} x \ge 3 \\ x \ge 5 \end{cases}$</div><div class="quiz-a">$x \ge 5$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">Q3. $\begin{cases} 2x > 4 \\ -x > -1 \end{cases}$</div><div class="quiz-a">上：$x>2$、下：$x<1$<br>重なりなし $\to$ 解なし</div></div>
        </div>
    </div>

    <div class="slide">
        <h1 style="color: var(--accent-secondary);">第4章<br>二次関数とグラフの構造</h1>
    </div>

    <div class="slide">
        <h2>そもそも二次関数とは？</h2>
        <p>$y = x^2$ のように、xを2回かけたものが主役の関数です。</p>
        <div class="box fragment">
            <p>x (1辺) $\to$ y (正方形の面積)</p>
            <ul>
                <li>$x=1$ のとき、$y = 1 \times 1 = 1$</li>
                <li>$x=2$ のとき、$y = 2 \times 2 = 4$</li>
                <li>$x=3$ のとき、$y = 3 \times 3 = 9$</li>
            </ul>
        </div>
        <p class="fragment">急激に増えていくのが特徴です。</p>
    </div>

    <div class="slide">
        <h2>グラフの描き方（順々プロット）</h2>
        <p>計算結果 $(x, y)$ を一つずつプロットすると、曲線が現れます。</p>
        <div class="interactive-area" style="height: 400px;">
            <svg id="svg-plot" viewBox="-4 -2 8 13" style="background:#111; height:100%; width:auto; border:1px solid #333;">
                <defs>
                    <pattern id="grid" width="1" height="1" patternUnits="userSpaceOnUse">
                        <path d="M 1 0 L 0 0 0 1" fill="none" stroke="#222" stroke-width="0.05"/>
                    </pattern>
                </defs>
                <rect x="-4" y="-2" width="8" height="15" fill="url(#grid)" />
                <line x1="-4" y1="0" x2="4" y2="0" stroke="#888" stroke-width="0.05"/>
                <line x1="0" y1="-2" x2="0" y2="10" stroke="#888" stroke-width="0.05"/>
                <text x="3.5" y="-0.2" font-size="0.5" fill="#888">x</text>
                <text x="0.2" y="10" font-size="0.5" fill="#888">y</text>
                <text x="-0.3" y="-0.2" font-size="0.5" fill="#888">0</text>
                <g id="plot-points"></g>
                <path id="plot-line" d="" stroke="var(--accent-primary)" stroke-width="0.1" fill="none"/>
                <text id="plot-status" x="0" y="-1.5" font-size="0.6" fill="white" text-anchor="middle"></text>
            </svg>
            <button class="btn" onclick="runPlotAnimation()" style="margin-top:10px;">プロット開始</button>
        </div>
    </div>

    <div class="slide">
        <h1 style="color: var(--accent-tertiary);">第5章<br>平方完成の「魔法」</h1>
        <p>一般形 $ax^2+bx+c$ から 標準形 $a(x-p)^2+q$ へ</p>
    </div>

    <div class="slide">
        <h2>「一般形」は使いにくい？</h2>
        <p>$y = x^2 + 4x + 3$ （一般形）</p>
        <div class="box fragment">
            <p>この式だけ見ても、<br><strong>「頂点がどこにあるか」</strong><br>パッとは分かりません。</p>
        </div>
        <p class="fragment">グラフを自由に動かすために、式の形を変身させる必要があります。<br>それが<span class="important">平方完成</span>です。</p>
    </div>

    <div class="slide">
        <h2>平方完成の正体</h2>
        <div class="box">
            <p style="font-size:1.8rem;">中途半端な長方形を、<br><span class="highlight">正方形に作り直す</span>作業</p>
        </div>
        <p>面積図のパズルとして理解しましょう。</p>
    </div>

    <div class="slide">
        <h2>1. 面積として見る</h2>
        <p>基本ルール：</p>
        <div class="row">
            <div class="col box">
                <h3>$x^2$</h3>
                <svg viewBox="0 0 100 100" style="height:100px;">
                    <rect x="10" y="10" width="80" height="80" fill="none" stroke="var(--accent-primary)" stroke-width="2"/>
                    <text x="50" y="55" fill="white" text-anchor="middle">x²</text>
                </svg>
                <p>一辺が $x$ の正方形</p>
            </div>
            <div class="col box">
                <h3>$4x$</h3>
                <svg viewBox="0 0 100 100" style="height:100px;">
                    <rect x="20" y="10" width="60" height="80" fill="none" stroke="var(--accent-secondary)" stroke-width="2"/>
                    <text x="50" y="55" fill="white" text-anchor="middle">4x</text>
                </svg>
                <p>縦 $x$、横 4 の長方形</p>
            </div>
        </div>
    </div>

    <div class="slide">
        <h2>2. 具体例： $x^2 + 4x$</h2>
        <p>この2つを合体させます。</p>
        <div class="interactive-area" style="height:200px;">
            <svg viewBox="0 0 300 150">
                <rect x="50" y="25" width="100" height="100" class="anim-box"/>
                <text x="100" y="75" fill="white" text-anchor="middle">x²</text>
                <rect x="155" y="25" width="80" height="100" class="anim-rect"/>
                <text x="195" y="75" fill="white" text-anchor="middle">4x</text>
                <text x="100" y="20" fill="var(--accent-primary)" text-anchor="middle">x</text>
                <text x="195" y="20" fill="var(--accent-secondary)" text-anchor="middle">4</text>
            </svg>
        </div>
        <p>「正方形」＋「長方形」の状態です。</p>
    </div>

    <div class="slide">
        <h2>3. 分割の発想</h2>
        <p>長方形 $4x$ を、<span class="highlight">半分（2等分）</span>にします。</p>
        <div class="box">
            <p>$4x = 2x + 2x$</p>
        </div>
        <div class="interactive-area" style="height:200px;">
            <svg viewBox="0 0 300 150">
                <rect x="50" y="25" width="100" height="100" class="anim-box"/>
                <text x="100" y="75" fill="white" text-anchor="middle">x²</text>
                <rect x="155" y="25" width="40" height="100" class="anim-rect"/>
                <text x="175" y="75" fill="white" text-anchor="middle">2x</text>
                <rect x="200" y="25" width="40" height="100" class="anim-rect"/>
                <text x="220" y="75" fill="white" text-anchor="middle">2x</text>
            </svg>
        </div>
    </div>

    <div class="slide">
        <h2>4. 並べ替え（移動）</h2>
        <p>半分にした片方を、正方形の下に移動します。</p>
        <div class="interactive-area" style="height:300px;">
            <svg viewBox="0 0 300 250">
                <rect x="50" y="25" width="100" height="100" class="anim-box"/>
                <text x="100" y="75" fill="white" text-anchor="middle">x²</text>
                
                <rect x="150" y="25" width="40" height="100" class="anim-rect"/>
                <text x="170" y="75" fill="white" text-anchor="middle">2x</text>
                
                <rect x="50" y="125" width="100" height="40" class="anim-rect"/>
                <text x="100" y="150" fill="white" text-anchor="middle">2x</text>
                
                <rect x="150" y="125" width="40" height="40" class="anim-target"/>
                <text x="170" y="150" fill="var(--accent-tertiary)" text-anchor="middle">?</text>
            </svg>
        </div>
        <p>右下に<span class="warn">「空白（？）」</span>ができました。</p>
    </div>

    <div class="slide">
        <h2>5. 穴を埋める</h2>
        <p>この空白の面積はいくつでしょう？</p>
        <div class="row">
            <div class="col box">
                <p>縦の幅： $2$ （半分にした値）</p>
                <p>横の幅： $2$ （半分にした値）</p>
            </div>
            <div class="col box">
                <p>面積 = $2 \times 2 = 4$</p>
            </div>
        </div>
        <div class="interactive-area" style="height:150px;">
            <svg viewBox="0 0 100 100">
                <rect x="25" y="25" width="50" height="50" class="anim-fill" style="opacity:1;"/>
                <text x="50" y="55" fill="black" text-anchor="middle" font-weight="bold">4</text>
            </svg>
        </div>
    </div>

    <div class="slide">
        <h2>6. 大きな正方形の完成</h2>
        <p>空白を埋めると、一辺が $(x+2)$ の正方形になります。</p>
        <div class="box">
            <p>$x^2 + 4x \class{important}{+ 4} = (x+2)^2$</p>
        </div>
        <p>これが平方完成の式の意味です。</p>
    </div>

    <div class="slide">
        <h2>7. 帳尻合わせ（最重要）</h2>
        <p>しかし、勝手に $+4$ してはいけません。</p>
        <p class="fragment">だから、<strong>足した分をすぐに引きます</strong>。</p>
        <div class="box fragment">
            <p>$x^2 + 4x$</p>
            <p>$= (x^2 + 4x \class{important}{+ 4}) \class{warn}{- 4}$</p>
            <p>$= (x+2)^2 - 4$</p>
        </div>
        <p class="fragment">これで、値を変えずに形だけ変えられました。</p>
    </div>

    <div class="slide">
        <h2>8. 平方完成の一般ルール</h2>
        <div class="box" style="width:100%;">
            <h3>係数を「半分」にして「2乗」する</h3>
        </div>
        <div class="row">
            <div class="col box">
                <p>$x^2 + \class{highlight}{a}x$</p>
                <p>半分： $a/2$</p>
                <p>2乗： $(a/2)^2$</p>
            </div>
            <div class="col box">
                <p>式：</p>
                <p>$(x + \frac{a}{2})^2 - (\frac{a}{2})^2$</p>
            </div>
        </div>
        <p class="warn">※図形的に、必ずそうなります。</p>
    </div>

    <div class="slide">
        <h2>視覚的平方完成：アニメーション</h2>
        <div class="interactive-area" style="height: 350px;">
            <svg id="svg-square" viewBox="0 0 400 300">
                <rect id="sq-x2" class="anim-box" x="100" y="50" width="100" height="100" />
                <text x="150" y="100" fill="white" text-anchor="middle" font-size="20">x²</text>
                <g id="grp-4x">
                    <rect class="anim-rect" x="205" y="50" width="80" height="100" />
                    <text x="245" y="100" fill="white" text-anchor="middle" font-size="20">4x</text>
                </g>
                <g id="grp-split" opacity="0">
                    <rect id="rect-r" class="anim-rect" x="205" y="50" width="40" height="100" />
                    <text id="txt-r" x="225" y="40" fill="var(--accent-secondary)" text-anchor="middle" font-size="16">2</text>
                    <rect id="rect-b" class="anim-rect" x="250" y="50" width="40" height="100" />
                </g>
                <rect id="sq-missing" class="anim-target" x="205" y="155" width="40" height="40" opacity="0"/>
                <rect id="sq-fill" class="anim-fill" x="205" y="155" width="40" height="40" />
                <text id="txt-missing" x="225" y="180" fill="var(--accent-tertiary)" text-anchor="middle" opacity="0">?</text>
            </svg>
            <div style="margin-top:10px;">
                <button class="btn" onclick="animSquare(1)">1. 長方形を割る</button>
                <button class="btn" onclick="animSquare(2)">2. 下に移動</button>
                <button class="btn" onclick="animSquare(3)">3. 穴を埋める</button>
                <button class="btn" onclick="animSquare(0)">リセット</button>
            </div>
            <p id="sq-status" style="height: 1.5em; margin-top:5px;">$x^2 + 4x$ は「正方形＋長方形」</p>
        </div>
    </div>

    <div class="slide">
        <h2>9. グラフとの関係</h2>
        <p>$y = (x+2)^2 - 4$</p>
        <div class="row">
            <div class="col fragment">
                <h3>$(x+2)^2$</h3>
                <p>x方向に <span class="highlight">-2</span> ずれる</p>
            </div>
            <div class="col fragment">
                <h3>$-4$</h3>
                <p>y方向に <span class="highlight">-4</span> ずれる</p>
            </div>
        </div>
        <p class="fragment box">頂点： $(-2, -4)$</p>
        <p class="fragment">平方完成＝「グラフの頂点を見つける技術」</p>
    </div>

    <div class="slide">
        <h2>10. ミニ練習</h2>
        <div class="quiz-container">
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">1. $x^2 + 6x$</div><div class="quiz-a">$(x+3)^2 - 9$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">2. $x^2 - 8x$</div><div class="quiz-a">$(x-4)^2 - 16$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">3. $x^2 + 2x$</div><div class="quiz-a">$(x+1)^2 - 1$</div></div>
            <div class="quiz-item" onclick="this.classList.toggle('revealed')"><div class="quiz-q">4. $x^2 - 10x$</div><div class="quiz-a">$(x-5)^2 - 25$</div></div>
        </div>
    </div>

    <div class="slide">
        <h2>「標準形」ならグラフは簡単</h2>
        <p style="margin:0;">$y = a(x-p)^2 + q$</p>
        
        <div style="display:flex; flex-direction:column; align-items:center; width:100%; height:90%;">
            <div class="box" style="margin: 5px 0; padding: 10px 20px;">
                <p style="margin:0; font-size:1.3rem;">頂点： $(p, q)$　/　形： $a$ (開き具合)</p>
            </div>
            
            <div class="interactive-area" style="padding: 10px; margin-top: 5px; width: 100%;">
                <svg id="svg-graph" viewBox="-6 -6 12 12" style="background:#111; border:1px solid #444; height:200px; width:100%; max-width:400px;">
                    <g id="grid-layer"></g>
                    <line x1="-10" y1="0" x2="10" y2="0" stroke="#888" stroke-width="0.1"/>
                    <line x1="0" y1="-10" x2="0" y2="10" stroke="#888" stroke-width="0.1"/>
                    <path id="graph-path" d="" stroke="var(--accent-primary)" stroke-width="0.2" fill="none"/>
                    <circle id="vertex-point" cx="0" cy="0" r="0.3" fill="var(--accent-secondary)"/>
                </svg>

                <div class="slider-container">
                    <div class="slider-row">
                        <div class="slider-label" style="color:var(--accent-primary);">a=<span id="val-a">1.0</span></div>
                        <input type="range" id="input-a" min="-3" max="3" step="0.1" value="1" oninput="updateGraphVertex()">
                    </div>
                    <div class="slider-row">
                        <div class="slider-label" style="color:var(--accent-secondary);">p=<span id="val-p">2.0</span></div>
                        <input type="range" id="input-p" min="-4" max="4" step="0.5" value="2" oninput="updateGraphVertex()">
                    </div>
                    <div class="slider-row">
                        <div class="slider-label" style="color:var(--accent-tertiary);">q=<span id="val-q">-1.0</span></div>
                        <input type="range" id="input-q" min="-4" max="4" step="0.5" value="-1" oninput="updateGraphVertex()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="slide">
        <h2>二次不等式の解き方（本質）</h2>
        <div class="box">
            <p style="font-size: 2rem;">$x^2 - 4x + 3 > 0$</p>
        </div>
        <p class="fragment">1. グラフを描く（交点を求める）</p>
        <p class="fragment highlight" style="font-size: 1.8rem;">2. 「水面(x軸)より上か下か」を見る</p>
    </div>

    <div class="slide">
        <h2>【視覚化】上側か、下側か</h2>
        <div class="interactive-area">
            <svg id="svg-quad" viewBox="0 0 400 300">
                <line x1="0" y1="150" x2="400" y2="150" stroke="#888" stroke-width="2"/>
                <text x="380" y="140" fill="#888" text-anchor="end">y = 0</text>
                <path id="main-parabola" d="" stroke="#555" stroke-width="2" fill="none"/>
                <path id="quad-highlight" d="" stroke-width="6" fill="none" stroke-linecap="round"/>
                <circle cx="129" cy="150" r="6" fill="white"/>
                <circle cx="271" cy="150" r="6" fill="white"/>
                <text x="129" y="180" fill="white" text-anchor="middle" font-size="18">α</text>
                <text x="271" y="180" fill="white" text-anchor="middle" font-size="18">β</text>
            </svg>
            <div style="display:flex; gap:20px; margin-top:20px;">
                <button class="btn" onclick="setQuadMode('gt')">$> 0$ (上側)</button>
                <button class="btn" onclick="setQuadMode('lt')">$< 0$ (下側)</button>
            </div>
            <p id="quad-result" class="highlight" style="margin-top:10px; height: 1.5em;">ボタンを押して範囲を確認</p>
        </div>
    </div>

    <div class="slide">
        <h2>判別式とグラフの関係まとめ</h2>
        <table style="font-size: 1rem;">
            <tr><th>判別式 $D$</th><th>$D > 0$</th><th>$D = 0$</th><th>$D < 0$</th></tr>
            <tr><td>解の個数</td><td>異なる2つの実数解</td><td>1つの実数解（重解）</td><td>実数解なし</td></tr>
            <tr>
                <td>グラフ</td>
                <td>
                    <svg viewBox="0 0 100 60" style="height:60px;">
                        <line x1="0" y1="30" x2="100" y2="30" stroke="#fff" stroke-width="1.5"/>
                        <path d="M 10 10 Q 50 80 90 10" stroke="var(--accent-primary)" fill="none" stroke-width="2"/>
                        <circle cx="28" cy="30" r="2.5" fill="white"/>
                        <circle cx="72" cy="30" r="2.5" fill="white"/>
                    </svg>
                </td>
                <td>
                    <svg viewBox="0 0 100 60" style="height:60px;">
                        <line x1="0" y1="40" x2="100" y2="40" stroke="#fff" stroke-width="1.5"/>
                        <path d="M 10 0 Q 50 80 90 0" stroke="var(--accent-secondary)" fill="none" stroke-width="2"/>
                        <circle cx="50" cy="40" r="2.5" fill="white"/>
                    </svg>
                </td>
                <td>
                    <svg viewBox="0 0 100 60" style="height:60px;">
                        <line x1="0" y1="50" x2="100" y2="50" stroke="#fff" stroke-width="1.5"/>
                        <path d="M 10 0 Q 50 40 90 0" stroke="var(--accent-tertiary)" fill="none" stroke-width="2"/>
                    </svg>
                </td>
            </tr>
            <tr><td>共有点</td><td>2個（交わる）</td><td>1個（接する）</td><td>0個（浮く）</td></tr>
        </table>
    </div>

    <div class="slide">
        <h2>応用：自動ブレーキの仕組み</h2>
        
        <div style="display: flex; flex-direction: column; width: 100%; max-width: 900px; gap: 10px;">
            <div class="box" style="text-align: left; background: rgba(0,210,255,0.05); padding: 15px; width: auto;">
                <p style="margin:0; font-size:1.2rem;">
                    <strong>停止距離 $\propto$ 速度の2乗</strong>：速度が2倍だと距離は4倍。<br>
                    <strong>不等式</strong>： $\text{停止距離}(v) \le \text{前方との距離}$ が崩れるとブレーキ作動。
                </p>
            </div>

            <div class="interactive-area" style="width: 100%; padding: 10px;">
                <div style="width:90%; display:flex; align-items:center; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-size:1.2rem;">速度 $v$</span>
                    <input type="range" id="brake-speed" min="0" max="100" value="40" oninput="updateBrake()">
                    <span id="speed-val" style="font-size:1.2rem; width:50px; text-align:right;">40</span>
                </div>
                
                <svg id="brake-sim" viewBox="0 0 800 120" style="background:#222; border-radius:10px; max-height: 200px;">
                    <rect x="0" y="80" width="800" height="40" fill="#444"/>
                    <line x1="0" y1="100" x2="800" y2="100" stroke="#fff" stroke-dasharray="20"/>
                    <g id="car-group" transform="translate(50, 60)">
                        <rect x="0" y="0" width="60" height="30" fill="var(--accent-primary)"/>
                        <circle cx="15" cy="30" r="8" fill="#aaa"/>
                        <circle cx="45" cy="30" r="8" fill="#aaa"/>
                    </g>
                    <rect x="700" y="30" width="20" height="90" fill="#888"/>
                    <line x1="110" y1="60" x2="700" y2="60" stroke="#888" stroke-width="2" marker-end="url(#arrow-grey)"/>
                    <text x="400" y="50" fill="#888" text-anchor="middle" font-size="14">距離 (一定)</text>
                    <rect id="stop-dist-bar" x="110" y="70" width="0" height="8" fill="var(--accent-tertiary)" opacity="0.7"/>
                    <text id="alert-msg" x="400" y="60" fill="var(--accent-secondary)" font-size="30" font-weight="bold" text-anchor="middle" opacity="0">BRAKE!</text>
                    <defs>
                        <marker id="arrow-grey" markerWidth="10" markerHeight="10" refX="0" refY="3" orient="auto"><path d="M0,0 L0,6 L9,3 z" fill="#888" /></marker>
                    </defs>
                </svg>
                <p id="ineq-status" style="font-size:1.4rem; margin: 5px 0;">OK: 安全圏内</p>
            </div>
        </div>
    </div>

    <div class="slide">
        <h1>お疲れ様でした</h1>
        <p>これで基礎講座は終了です。</p>
        <div style="margin-top: 50px;">
            <button class="btn" onclick="goToSlide(0)">最初に戻る</button>
        </div>
    </div>
    
    <div class="slide"></div><div class="slide"></div>

</div>

<div id="controls">
    <button class="btn" onclick="prevStep()">◀</button>
    <button class="btn" onclick="nextStep()">▶</button>
</div>
<div id="progress-bar"></div>
<div id="slide-number">1 / 52</div>

<script>
    const slides = document.querySelectorAll('.slide');
    const progressBar = document.getElementById('progress-bar');
    const slideNumberDisplay = document.getElementById('slide-number');
    let currentSlide = 0;

    slides.forEach(slide => {
        slide.dataset.currentFragment = -1;
        slide.dataset.totalFragments = slide.querySelectorAll('.fragment').length;
    });

    function updateView() {
        slides.forEach((slide, index) => {
            slide.classList.remove('active', 'past');
            if (index === currentSlide) {
                slide.classList.add('active');
            } else if (index < currentSlide) {
                slide.classList.add('past');
            }
        });
        const progress = ((currentSlide + 1) / slides.length) * 100;
        progressBar.style.width = `${progress}%`;
        slideNumberDisplay.textContent = `${currentSlide + 1} / ${slides.length}`;
    }

    function nextStep() {
        const slide = slides[currentSlide];
        const totalFragments = parseInt(slide.dataset.totalFragments);
        let currentFragment = parseInt(slide.dataset.currentFragment);

        if (currentFragment < totalFragments - 1) {
            currentFragment++;
            const fragments = slide.querySelectorAll('.fragment');
            fragments[currentFragment].classList.add('visible');
            slide.dataset.currentFragment = currentFragment;
        } else {
            if (currentSlide < slides.length - 1) {
                currentSlide++;
                updateView();
            }
        }
    }

    function prevStep() {
        const slide = slides[currentSlide];
        let currentFragment = parseInt(slide.dataset.currentFragment);

        if (currentFragment >= 0) {
            const fragments = slide.querySelectorAll('.fragment');
            fragments[currentFragment].classList.remove('visible');
            slide.dataset.currentFragment = currentFragment - 1;
        } else {
            if (currentSlide > 0) {
                currentSlide--;
                updateView();
            }
        }
    }

    function goToSlide(index) {
        slides.forEach(slide => {
            slide.dataset.currentFragment = -1;
            slide.querySelectorAll('.fragment').forEach(f => f.classList.remove('visible'));
        });
        currentSlide = index;
        updateView();
    }

    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') nextStep();
        if (e.key === 'ArrowLeft') prevStep();
    });

    // 1. Flip
    function updateFlip() {
        const angleDeg = document.getElementById('flip-slider').value;
        const angleRad = angleDeg * (Math.PI / 180);
        const cos = Math.cos(angleRad);
        const ball2 = document.getElementById('ball-2');
        const ball5 = document.getElementById('ball-5');
        const textIneq = document.getElementById('text-ineq');
        const x2 = 80, x5 = 200;
        ball2.setAttribute('transform', `translate(${x2 * cos - x2}, 0)`);
        ball5.setAttribute('transform', `translate(${x5 * cos - x5}, 0)`);
        if (cos >= 0) {
            textIneq.textContent = "5 > 2";
            textIneq.setAttribute('x', 140 * cos);
        } else {
            textIneq.textContent = "-5 < -2";
            textIneq.setAttribute('x', 140 * cos);
        }
    }

    // 2. Plot Animation (Corrected)
    function runPlotAnimation() {
        const path = document.getElementById('plot-line');
        const pointsGroup = document.getElementById('plot-points');
        const status = document.getElementById('plot-status');
        pointsGroup.innerHTML = '';
        path.setAttribute('d', '');
        
        const keyPoints = [-3, -2, -1, 0, 1, 2, 3];
        let i = 0;

        function drawCurve() {
            let fullD = "";
            for(let x=-4; x<=4; x+=0.1) {
                let y = x*x;
                let sy = -y; 
                if(x===-4) fullD += `M ${x} ${sy}`;
                else fullD += ` L ${x} ${sy}`;
            }
            path.setAttribute('d', fullD);
        }
        
        function step() {
            if (i >= keyPoints.length) {
                status.textContent = "完成： y = x²";
                drawCurve();
                return;
            }
            const x = keyPoints[i];
            const y = x*x;
            const sy = -y; 
            status.textContent = `x = ${x} のとき...`;
            setTimeout(() => {
                status.textContent = `x = ${x} ... 2乗すると ... y = ${y}`;
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("cx", x); circle.setAttribute("cy", sy);
                circle.setAttribute("r", 0.15); circle.setAttribute("fill", "white");
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute("x1", x); line.setAttribute("y1", 0); 
                line.setAttribute("x2", x); line.setAttribute("y2", sy);
                line.setAttribute("stroke", "#555"); line.setAttribute("stroke-width", "0.05");
                line.setAttribute("stroke-dasharray", "0.2");
                pointsGroup.appendChild(line); pointsGroup.appendChild(circle);
                i++;
                setTimeout(step, 800);
            }, 600);
        }
        step();
    }

    // 3. Square Completion Animation
    function animSquare(step) {
        const status = document.getElementById('sq-status');
        const split = document.getElementById('grp-split');
        const grp4x = document.getElementById('grp-4x');
        const rectB = document.getElementById('rect-b');
        const target = document.getElementById('sq-missing');
        const fill = document.getElementById('sq-fill');
        const txtMiss = document.getElementById('txt-missing');

        if(step === 0) {
            grp4x.setAttribute('opacity', 1);
            split.setAttribute('opacity', 0);
            rectB.setAttribute('y', 50); rectB.setAttribute('x', 250);
            rectB.setAttribute('width', 40); rectB.setAttribute('height', 100);
            target.setAttribute('opacity', 0); fill.setAttribute('opacity', 0);
            txtMiss.setAttribute('opacity', 0);
            status.textContent = "$x^2 + 4x$ は「正方形＋長方形」";
            MathJax.typesetPromise([status]);
            return;
        }
        if(step === 1) {
            grp4x.setAttribute('opacity', 0); split.setAttribute('opacity', 1);
            status.textContent = "1. 長方形 $4x$ を半分 ($2x, 2x$) に割る";
            MathJax.typesetPromise([status]);
        }
        if(step === 2) {
            rectB.style.transition = "all 1s";
            rectB.setAttribute('x', 100); rectB.setAttribute('y', 150);
            rectB.setAttribute('width', 100); rectB.setAttribute('height', 40); 
            status.textContent = "2. 半分を下に移動する";
        }
        if(step === 3) {
            target.setAttribute('x', 200); target.setAttribute('y', 150);
            fill.setAttribute('x', 200); fill.setAttribute('y', 150);
            target.setAttribute('opacity', 1);
            setTimeout(() => {
                txtMiss.setAttribute('opacity', 1); txtMiss.setAttribute('x', 220); txtMiss.setAttribute('y', 175);
                fill.setAttribute('opacity', 1);
                status.innerHTML = "3. 空いた角を埋めるには $2 \\times 2 = 4$ が必要";
                MathJax.typesetPromise([status]);
            }, 500);
        }
    }

    // 4. Vertex Graph
    function drawGridVertex() {
        const grid = document.getElementById('grid-layer');
        grid.innerHTML = '';
        for(let x = -10; x <= 10; x+=1) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x); line.setAttribute("y1", -10);
            line.setAttribute("x2", x); line.setAttribute("y2", 10);
            line.setAttribute("stroke", "#333"); line.setAttribute("stroke-width", "0.05");
            grid.appendChild(line);
        }
        for(let y = -10; y <= 10; y+=1) {
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", -10); line.setAttribute("y1", y);
            line.setAttribute("x2", 10); line.setAttribute("y2", y);
            line.setAttribute("stroke", "#333"); line.setAttribute("stroke-width", "0.05");
            grid.appendChild(line);
        }
    }
    drawGridVertex();

    function updateGraphVertex() {
        const a = parseFloat(document.getElementById('input-a').value);
        const p = parseFloat(document.getElementById('input-p').value);
        const q = parseFloat(document.getElementById('input-q').value);
        document.getElementById('val-a').textContent = a.toFixed(1);
        document.getElementById('val-p').textContent = p.toFixed(1);
        document.getElementById('val-q').textContent = q.toFixed(1);
        const vDot = document.getElementById('vertex-point');
        vDot.setAttribute('cx', p); vDot.setAttribute('cy', -q);
        let d = "M"; let started = false;
        for (let x = -10; x <= 10; x += 0.1) {
            const y = a * Math.pow(x - p, 2) + q;
            const plotY = -y; 
            if (plotY > 10 || plotY < -10) continue; 
            if (!started) { d += ` ${x} ${plotY}`; started = true; } else { d += ` L ${x} ${plotY}`; }
        }
        document.getElementById('graph-path').setAttribute('d', d);
    }
    updateGraphVertex();

    // 5. Quadratic Inequality
    function generatePath(mode) {
        let d = "";
        let segments = [];
        if (!mode) segments.push([0, 400]);
        else if (mode === 'lt') segments.push([129, 271]);
        else { segments.push([0, 129]); segments.push([271, 400]); }
        segments.forEach(seg => {
            for (let x = seg[0]; x <= seg[1]; x+=5) {
                let val = 0.01 * Math.pow(x - 200, 2) - 50;
                let sy = 150 - val; 
                if (x === seg[0]) d += `M ${x} ${sy}`; else d += ` L ${x} ${sy}`;
            }
        });
        return d;
    }
    document.getElementById('main-parabola').setAttribute('d', generatePath(null));

    function setQuadMode(mode) {
        const path = document.getElementById('quad-highlight');
        const text = document.getElementById('quad-result');
        path.setAttribute('d', generatePath(mode));
        if (mode === 'gt') {
            path.setAttribute('stroke', 'var(--accent-secondary)');
            text.innerHTML = '上側 ($>0$) $\\to$ 外側'; text.style.color = 'var(--accent-secondary)';
        } else {
            path.setAttribute('stroke', 'var(--accent-primary)');
            text.innerHTML = '下側 ($<0$) $\\to$ 内側'; text.style.color = 'var(--accent-primary)';
        }
        MathJax.typesetPromise([text]);
    }

    // 6. Auto Brake
    function updateBrake() {
        const v = parseInt(document.getElementById('brake-speed').value);
        document.getElementById('speed-val').textContent = v;
        const dist = 0.06 * v * v; 
        const bar = document.getElementById('stop-dist-bar');
        const alert = document.getElementById('alert-msg');
        const status = document.getElementById('ineq-status');
        bar.setAttribute('width', dist);
        const limit = 590; 
        if (dist > limit) {
            bar.setAttribute('fill', 'var(--accent-secondary)');
            alert.setAttribute('opacity', 1);
            status.innerHTML = `<span class="warn">危険！</span> 停止距離(${dist.toFixed(0)}) > 距離`;
            status.style.color = 'var(--accent-secondary)';
        } else {
            bar.setAttribute('fill', 'var(--accent-tertiary)');
            alert.setAttribute('opacity', 0);
            status.innerHTML = `OK: 停止距離(${dist.toFixed(0)}) $\\le$ 距離`;
            status.style.color = 'var(--accent-tertiary)';
        }
        MathJax.typesetPromise([status]);
    }

    updateView();

</script>
</body>
</html>